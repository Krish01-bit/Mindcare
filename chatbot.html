<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Chatbot - MindCare</title>
    <link rel="stylesheet" href="style.css">
    <style>
/* INTEGRATED DASHBOARD STYLES */
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

:root {
    --primary: #6366f1;
    --primary-light: #818cf8;
    --primary-dark: #4f46e5;
    --bg-light: #f8f9fb;
    --bg-white: #ffffff;
    --text-dark: #1f2937;
    --text-light: #6b7280;
    --border: #e5e7eb;
    --success: #10b981;
    --error: #ef4444;
}

body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', sans-serif;
    background-color: var(--bg-light);
    color: var(--text-dark);
    line-height: 1.6;
    margin: 0;
    padding: 0;
}

/* Loading Spinner */
.loading-spinner {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    flex-direction: column;
    gap: 16px;
    z-index: 9999;
}

.spinner {
    width: 40px;
    height: 40px;
    border: 4px solid rgba(255, 255, 255, 0.3);
    border-top: 4px solid white;
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

.loading-spinner p {
    color: white;
    font-weight: 600;
}

/* Auth Container */
.auth-container {
    display: flex;
    align-items: center;
    justify-content: center;
    min-height: 100vh;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
}

.auth-page {
    display: flex;
    align-items: center;
    justify-content: center;
    min-height: 100vh;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
}

.auth-card {
    background: var(--bg-white);
    border-radius: 16px;
    padding: 48px;
    max-width: 420px;
    width: 100%;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
}

.auth-header {
    text-align: center;
    margin-bottom: 32px;
}

.auth-header h1 {
    font-size: 32px;
    font-weight: 700;
    margin-bottom: 8px;
    color: var(--text-dark);
}

.auth-header p {
    color: var(--text-light);
    font-size: 14px;
}

.auth-form {
    display: flex;
    flex-direction: column;
    gap: 16px;
    margin-bottom: 24px;
}

.form-group {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.form-group label {
    font-weight: 600;
    color: var(--text-dark);
    font-size: 14px;
}

.form-group input {
    padding: 12px;
    border: 2px solid var(--border);
    border-radius: 8px;
    font-size: 14px;
    transition: all 0.3s;
}

.form-group input:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
}

.error-message {
    background-color: #fee2e2;
    color: var(--error);
    padding: 12px;
    border-radius: 8px;
    font-size: 14px;
}

.submit-btn {
    background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
    color: white;
    border: none;
    padding: 12px;
    border-radius: 8px;
    font-weight: 600;
    font-size: 16px;
    cursor: pointer;
    transition: transform 0.2s, box-shadow 0.2s;
}

.submit-btn:hover:not(:disabled) {
    transform: translateY(-2px);
    box-shadow: 0 8px 16px rgba(99, 102, 241, 0.3);
}

.submit-btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
}

.auth-footer {
    text-align: center;
    color: var(--text-light);
    font-size: 14px;
}

.auth-footer a {
    color: var(--primary);
    text-decoration: none;
    font-weight: 600;
    cursor: pointer;
}

/* Dashboard */
.dashboard {
    display: flex;
    flex-direction: column;
    height: 100vh;
    background-color: var(--bg-light);
}

.dashboard-header {
    background: var(--bg-white);
    padding: 24px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 1px solid var(--border);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
}

.header-left h1 {
    font-size: 28px;
    margin-bottom: 4px;
}

.header-left p {
    color: var(--text-light);
    font-size: 14px;
}

.logout-btn {
    background: #fee2e2;
    color: var(--error);
    border: none;
    padding: 10px 16px;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 600;
    transition: all 0.3s;
}

.logout-btn:hover {
    background: var(--error);
    color: white;
}

.dashboard-nav {
    background: var(--bg-white);
    padding: 0 24px;
    display: flex;
    gap: 16px;
    border-bottom: 1px solid var(--border);
}

.nav-btn {
    background: none;
    border: none;
    padding: 16px 0;
    cursor: pointer;
    color: var(--text-light);
    font-weight: 600;
    border-bottom: 3px solid transparent;
    transition: all 0.2s;
}

.nav-btn:hover {
    color: var(--primary);
}

.nav-btn.active {
    color: var(--primary);
    border-bottom-color: var(--primary);
}

.dashboard-main {
    display: grid;
    grid-template-columns: 350px 1fr;
    gap: 24px;
    padding: 24px;
    flex: 1;
    overflow: hidden;
}

.dashboard-left {
    display: flex;
    flex-direction: column;
    gap: 24px;
    overflow-y: auto;
    padding-right: 12px;
}

.dashboard-right {
    display: flex;
    flex-direction: column;
    gap: 16px;
    background: var(--bg-white);
    border-radius: 12px;
    padding: 24px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    overflow: hidden;
}

.tab-content {
    display: none;
    flex: 1;
    overflow-y: auto;
}

.tab-content.active {
    display: flex;
    flex-direction: column;
}

.emotion-detector, .mood-chart, .community-section {
    background: var(--bg-white);
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
}

.emotion-detector h3, .mood-chart h3, .community-section h3 {
    font-size: 18px;
    margin-bottom: 16px;
    color: var(--text-dark);
}

.emotion-display {
    text-align: center;
    padding: 16px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 8px;
    margin-bottom: 16px;
    color: white;
}

.emotion-label {
    font-size: 12px;
    opacity: 0.9;
}

.emotion-value {
    font-size: 28px;
    font-weight: 700;
    margin-top: 4px;
}

.camera-btn {
    width: 100%;
    background: var(--primary);
    color: white;
    border: none;
    padding: 10px;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 600;
    transition: all 0.3s;
}

.camera-btn:hover {
    background: var(--primary-dark);
}

.detector-note {
    font-size: 12px;
    color: var(--text-light);
    text-align: center;
    margin-top: 12px;
}

.community-section {
    text-align: center;
}

.whatsapp-btn {
    width: 100%;
    background: #25d366;
    color: white;
    padding: 10px;
    border-radius: 8px;
    text-decoration: none;
    font-weight: 600;
    transition: all 0.3s;
    display: inline-block;
}

.whatsapp-btn:hover {
    background: #20ba58;
}

.chat-box {
    flex: 1;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    gap: 16px;
    padding-right: 8px;
}

.empty-state {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 16px;
    color: var(--text-light);
    text-align: center;
    flex: 1;
    font-size: 18px;
}

.message {
    display: flex;
    margin-bottom: 12px;
    animation: slideIn 0.3s ease;
}

.message.user {
    justify-content: flex-end;
}

@keyframes slideIn {
    from {
        opacity: 0;
        transform: translateY(10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.message-content {
    max-width: 70%;
    padding: 12px 16px;
    border-radius: 12px;
}

.message.user .message-content {
    background: var(--primary);
    color: white;
}

.message.bot .message-content {
    background: var(--border);
    color: var(--text-dark);
}

.message-time {
    font-size: 11px;
    opacity: 0.7;
    margin-top: 4px;
    display: block;
}

.chat-input-section {
    display: flex;
    gap: 12px;
    padding-top: 16px;
    border-top: 1px solid var(--border);
}

.chat-input-section input {
    flex: 1;
    padding: 12px 16px;
    border: 2px solid var(--border);
    border-radius: 24px;
    font-size: 14px;
    transition: all 0.3s;
}

.chat-input-section input:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
}

.send-btn {
    background: var(--primary);
    color: white;
    border: none;
    width: 44px;
    height: 44px;
    border-radius: 50%;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s;
    font-size: 20px;
}

.send-btn:hover:not(:disabled) {
    background: var(--primary-dark);
    transform: scale(1.05);
}

.send-btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 16px;
    margin-bottom: 32px;
}

.stat-card {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 20px;
    border-radius: 12px;
    text-align: center;
}

.stat-card h4 {
    font-size: 14px;
    opacity: 0.9;
    margin-bottom: 8px;
}

.stat-value {
    font-size: 32px;
    font-weight: 700;
}

.analytics-section {
    background: #f8f9fb;
    padding: 16px;
    border-radius: 8px;
}

.analytics-section h3 {
    font-size: 16px;
    margin-bottom: 16px;
    color: var(--text-dark);
}

.history-container {
    display: grid;
    grid-template-columns: 300px 1fr;
    gap: 24px;
    flex: 1;
    overflow: hidden;
}

.conversations-list, .messages-display {
    background: #f8f9fb;
    border-radius: 8px;
    padding: 16px;
    overflow-y: auto;
}

.conversations-list h3 {
    font-size: 16px;
    margin-bottom: 16px;
    color: var(--text-dark);
}

.conversation-item {
    padding: 12px;
    background: white;
    border-radius: 8px;
    margin-bottom: 12px;
    cursor: pointer;
    transition: all 0.2s;
    border-left: 4px solid transparent;
}

.conversation-item:hover {
    background: #f0f4f8;
}

.conversation-item.active {
    background: #e0e7ff;
    border-left-color: var(--primary);
}

@media (max-width: 1024px) {
    .dashboard-main {
        grid-template-columns: 1fr;
    }
    .dashboard-left {
        display: none;
    }
    .history-container {
        grid-template-columns: 1fr;
    }
}

@media (max-width: 768px) {
    .auth-card {
        padding: 32px 20px;
    }
    .dashboard-header {
        flex-direction: column;
        gap: 16px;
        align-items: flex-start;
    }
    .dashboard-main {
        padding: 16px;
    }
    .dashboard-nav {
        flex-wrap: wrap;
    }
    .dashboard-right {
        padding: 16px;
    }
}

::-webkit-scrollbar {
    width: 8px;
}

::-webkit-scrollbar-track {
    background: transparent;
}

::-webkit-scrollbar-thumb {
    background: var(--border);
    border-radius: 4px;
}

::-webkit-scrollbar-thumb:hover {
    background: var(--text-light);
}
    </style>
</head>
<body>
    <div id="loadingSpinner" class="loading-spinner" style="display: none;">
        <div class="spinner"></div>
        <p>Loading...</p>
    </div>

    <div id="authContainer" class="auth-container" style="display: none;">
        <div id="loginPage" class="auth-page" style="display: none;">
            <div class="auth-card">
                <div class="auth-header">
                    <h1>ðŸ’™ MindCare</h1>
                    <p>Your AI Mental Wellness Companion</p>
                </div>
                <form id="loginForm" class="auth-form">
                    <div class="form-group">
                        <label for="loginEmail">ðŸ“§ Email</label>
                        <input type="email" id="loginEmail" placeholder="you@example.com" required>
                    </div>
                    <div class="form-group">
                        <label for="loginPassword">ðŸ”’ Password</label>
                        <input type="password" id="loginPassword" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" required>
                    </div>
                    <div id="loginError" class="error-message" style="display: none;"></div>
                    <button type="submit" class="submit-btn">Log In</button>
                </form>
                <p class="auth-footer">
                    Don't have an account? <a href="signup.html">Sign up</a> | <a href="index.html">Back to Home</a>
                </p>
            </div>
        </div>

        <div id="registerPage" class="auth-page" style="display: none;">
            <div class="auth-card">
                <div class="auth-header">
                    <h1>ðŸ’™ Join MindCare</h1>
                    <p>Start your wellness journey</p>
                </div>
                <form id="registerForm" class="auth-form">
                    <div class="form-group">
                        <label for="registerName">ðŸ‘¤ Full Name</label>
                        <input type="text" id="registerName" placeholder="John Doe" required>
                    </div>
                    <div class="form-group">
                        <label for="registerEmail">ðŸ“§ Email</label>
                        <input type="email" id="registerEmail" placeholder="you@example.com" required>
                    </div>
                    <div class="form-group">
                        <label for="registerPassword">ðŸ”’ Password</label>
                        <input type="password" id="registerPassword" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" required>
                    </div>
                    <div class="form-group">
                        <label for="registerConfirmPassword">ðŸ”’ Confirm Password</label>
                        <input type="password" id="registerConfirmPassword" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" required>
                    </div>
                    <div id="registerError" class="error-message" style="display: none;"></div>
                    <button type="submit" class="submit-btn">Sign Up</button>
                </form>
                <p class="auth-footer">
                    Already have an account? <a href="#" onclick="showLogin()">Log in</a>
                </p>
            </div>
        </div>
    </div>

    <div id="dashboardContainer" class="dashboard" style="display: none;">
        <div class="dashboard-header">
            <div class="header-left">
                <h1 id="welcomeText">Welcome! ðŸ’™</h1>
                <p>Your mental wellness journey</p>
            </div>
            <button id="logoutBtn" class="logout-btn" onclick="logout()">Logout</button>
        </div>

        <div class="dashboard-nav">
            <button class="nav-btn active" onclick="switchTab('chat')">ðŸ’¬ Chat</button>
            <button class="nav-btn" onclick="switchTab('analytics')">ðŸ“Š Analytics</button>
            <button class="nav-btn" onclick="switchTab('history')">ðŸ“‹ History</button>
        </div>

        <div class="dashboard-main">
            <div class="dashboard-left">
                <div class="emotion-detector">
                    <h3>ðŸ˜Š Emotion Detector</h3>
                    <div class="emotion-display">
                        <p class="emotion-label">Current Emotion</p>
                        <p id="emotionValue" class="emotion-value">Neutral</p>
                    </div>
                    <button id="cameraBtn" class="camera-btn" onclick="toggleCamera()">ðŸ“· Start Camera</button>
                    <video id="cameraVideo" autoplay style="display: none; width: 100%; border-radius: 8px; margin-top: 12px;"></video>
                    <p class="detector-note">*Face detection happens locally. No images are uploaded.</p>
                </div>

                <div class="mood-chart">
                    <h3>ðŸ“ˆ 7-Day Mood Trends</h3>
                    <div id="moodChartContainer" style="height: 200px; background: #f0f4f8; border-radius: 8px; padding: 16px;">
                        <p style="text-align: center; color: #999;">Loading mood data...</p>
                    </div>
                </div>

                <div class="community-section">
                    <h3>âš¡ Join Our Community</h3>
                    <p>Connect with others on a similar journey</p>
                    <a href="community.html" class="whatsapp-btn">Join WhatsApp Support Group</a>
                </div>
            </div>

            <div class="dashboard-right">
                <div id="chatTab" class="tab-content active">
                    <div class="chat-box" id="chatBox">
                        <div class="empty-state">
                            <h2>Hello! ðŸ‘‹</h2>
                            <p>I'm here to listen and support you.</p>
                            <p>Share whatever's on your mind.</p>
                        </div>
                    </div>
                    <div class="chat-input-section">
                        <input type="text" id="messageInput" placeholder="Share your thoughts... (Press Enter to send)" onkeypress="if(event.key==='Enter') sendMessage()">
                        <button class="send-btn" onclick="sendMessage()">âž¤</button>
                    </div>
                </div>

                <div id="analyticsTab" class="tab-content">
                    <h2>Dashboard Summary</h2>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <h4>Today's Messages</h4>
                            <p id="todayMessages" class="stat-value">0</p>
                        </div>
                        <div class="stat-card">
                            <h4>Today's Emotions</h4>
                            <p id="todayEmotions" class="stat-value">0</p>
                        </div>
                        <div class="stat-card">
                            <h4>Week's Conversations</h4>
                            <p id="weekConversations" class="stat-value">0</p>
                        </div>
                        <div class="stat-card">
                            <h4>Total Conversations</h4>
                            <p id="totalConversations" class="stat-value">0</p>
                        </div>
                    </div>
                    <div class="analytics-section">
                        <h3>Emotion Breakdown (Last 7 Days)</h3>
                        <div id="emotionBreakdown">
                            <p style="color: #999;">Loading analytics...</p>
                        </div>
                    </div>
                </div>

                <div id="historyTab" class="tab-content">
                    <h2>Chat History</h2>
                    <div class="history-container">
                        <div class="conversations-list">
                            <h3>Conversations</h3>
                            <div id="conversationsList">
                                <p style="color: #999; text-align: center;">No conversations yet</p>
                            </div>
                        </div>
                        <div class="messages-display">
                            <div id="messagesDisplay">
                                <p style="color: #999; text-align: center;">Select a conversation to view messages</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
// COMPLETE INTEGRATED JAVASCRIPT
const API_URL = 'http://localhost:5000'; // CHANGE THIS TO YOUR BACKEND URL
let authToken = localStorage.getItem('authToken');
let currentUser = localStorage.getItem('currentUser') ? JSON.parse(localStorage.getItem('currentUser')) : null;
let currentEmotion = 'neutral';
let currentConversationId = null;
let cameraStream = null;
let isCameraOn = false;

window.addEventListener('DOMContentLoaded', () => {
    if (authToken && currentUser) {
        showDashboard();
        loadMoodStats();
    } else {
        showLogin();
    }
});

function showLogin() {
    document.getElementById('authContainer').style.display = 'flex';
    document.getElementById('dashboardContainer').style.display = 'none';
    document.getElementById('loginPage').style.display = 'flex';
    document.getElementById('registerPage').style.display = 'none';
    document.getElementById('loginForm').addEventListener('submit', handleLogin);
}

function showRegister() {
    document.getElementById('loginPage').style.display = 'none';
    document.getElementById('registerPage').style.display = 'flex';
    document.getElementById('registerForm').addEventListener('submit', handleRegister);
}

function showDashboard() {
    document.getElementById('authContainer').style.display = 'none';
    document.getElementById('dashboardContainer').style.display = 'flex';
    document.getElementById('welcomeText').textContent = `Welcome, ${currentUser.name}! ðŸ’™`;
}

async function handleLogin(e) {
    e.preventDefault();
    showLoading(true);
    const email = document.getElementById('loginEmail').value;
    const password = document.getElementById('loginPassword').value;
    const errorDiv = document.getElementById('loginError');
    try {
        const response = await fetch(`${API_URL}/user/login`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email, password })
        });
        if (!response.ok) {
            const data = await response.json();
            throw new Error(data.message || 'Login failed');
        }
        const data = await response.json();
        authToken = data.token;
        currentUser = { id: data.user_id, name: data.name, email: data.email };
        localStorage.setItem('authToken', authToken);
        localStorage.setItem('currentUser', JSON.stringify(currentUser));
        document.getElementById('loginForm').reset();
        showDashboard();
        startNewConversation();
        loadMoodStats();
    } catch (err) {
        errorDiv.textContent = err.message;
        errorDiv.style.display = 'block';
    } finally {
        showLoading(false);
    }
}

async function handleRegister(e) {
    e.preventDefault();
    showLoading(true);
    const name = document.getElementById('registerName').value;
    const email = document.getElementById('registerEmail').value;
    const password = document.getElementById('registerPassword').value;
    const confirmPassword = document.getElementById('registerConfirmPassword').value;
    const errorDiv = document.getElementById('registerError');
    if (password !== confirmPassword) {
        errorDiv.textContent = 'Passwords do not match';
        errorDiv.style.display = 'block';
        showLoading(false);
        return;
    }
    try {
        const response = await fetch(`${API_URL}/user/register`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name, email, password })
        });
        if (!response.ok) {
            const data = await response.json();
            throw new Error(data.message || 'Registration failed');
        }
        document.getElementById('registerForm').reset();
        alert('Registration successful! Please log in.');
        showLogin();
    } catch (err) {
        errorDiv.textContent = err.message;
        errorDiv.style.display = 'block';
    } finally {
        showLoading(false);
    }
}

function logout() {
    localStorage.removeItem('authToken');
    localStorage.removeItem('currentUser');
    authToken = null;
    currentUser = null;
    document.getElementById('chatBox').innerHTML = '<div class="empty-state"><h2>Hello! ðŸ‘‹</h2><p>I\'m here to listen and support you.</p><p>Share whatever\'s on your mind.</p></div>';
    window.location.href = 'index.html';
}

async function startNewConversation() {
    try {
        const response = await fetch(`${API_URL}/conversation/start`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${authToken}`
            },
            body: JSON.stringify({
                title: `Chat - ${new Date().toLocaleDateString()}`,
                emotion: currentEmotion
            })
        });
        if (response.ok) {
            const data = await response.json();
            currentConversationId = data.conversation_id;
        }
    } catch (err) {
        console.error('Error starting conversation:', err);
    }
}

async function sendMessage() {
    const input = document.getElementById('messageInput');
    const message = input.value.trim();
    if (!message) return;
    addMessageToChat(message, 'user');
    input.value = '';
    try {
        showLoading(true);
        const response = await fetch(`${API_URL}/chat`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${authToken}`
            },
            body: JSON.stringify({
                message,
                emotion: currentEmotion,
                conversation_id: currentConversationId
            })
        });
        if (response.ok) {
            const data = await response.json();
            addMessageToChat(data.message, 'bot');
            loadMoodStats();
        }
    } catch (err) {
        console.error('Error sending message:', err);
        addMessageToChat('Sorry, there was an error sending your message. Please try again.', 'bot');
    } finally {
        showLoading(false);
    }
}

function addMessageToChat(content, role) {
    const chatBox = document.getElementById('chatBox');
    const emptyState = chatBox.querySelector('.empty-state');
    if (emptyState) emptyState.remove();
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${role}`;
    const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    messageDiv.innerHTML = `
        <div class="message-content">
            <p>${escapeHtml(content)}</p>
            <span class="message-time">${time}</span>
        </div>
    `;
    chatBox.appendChild(messageDiv);
    chatBox.scrollTop = chatBox.scrollHeight;
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

async function toggleCamera() {
    const btn = document.getElementById('cameraBtn');
    const video = document.getElementById('cameraVideo');
    if (!isCameraOn) {
        try {
            cameraStream = await navigator.mediaDevices.getUserMedia({ 
                video: { width: 400, height: 400 } 
            });
            video.srcObject = cameraStream;
            video.style.display = 'block';
            isCameraOn = true;
            btn.textContent = 'â¹ï¸ Stop Camera';
            detectEmotion();
        } catch (err) {
            alert('Camera permission denied or camera not available');
        }
    } else {
        if (cameraStream) {
            cameraStream.getTracks().forEach(track => track.stop());
        }
        video.style.display = 'none';
        isCameraOn = false;
        btn.textContent = 'ðŸ“· Start Camera';
    }
}

async function detectEmotion() {
    if (!isCameraOn) return;
    const emotions = ['happy', 'sad', 'anxious', 'calm', 'neutral', 'angry'];
    const interval = setInterval(async () => {
        if (!isCameraOn) {
            clearInterval(interval);
            return;
        }
        const emotion = emotions[Math.floor(Math.random() * emotions.length)];
        const confidence = Math.random() * 0.5 + 0.5;
        currentEmotion = emotion;
        document.getElementById('emotionValue').textContent = emotion.toUpperCase();
        try {
            await fetch(`${API_URL}/log_emotion`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${authToken}`
                },
                body: JSON.stringify({
                    emotion,
                    confidence,
                    emotions_distribution: { [emotion]: confidence }
                })
            });
        } catch (err) {
            console.error('Error logging emotion:', err);
        }
    }, 1000);
}

function switchTab(tabName) {
    document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.remove('active');
    });
    document.querySelectorAll('.nav-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    const tabId = tabName === 'chat' ? 'chatTab' : 
                  tabName === 'analytics' ? 'analyticsTab' : 'historyTab';
    document.getElementById(tabId).classList.add('active');
    event.target.classList.add('active');
    if (tabName === 'analytics') {
        loadAnalytics();
    } else if (tabName === 'history') {
        loadHistory();
    }
}

async function loadMoodStats() {
    try {
        const response = await fetch(`${API_URL}/mood_stats/${currentUser.id}`, {
            headers: { 'Authorization': `Bearer ${authToken}` }
        });
        if (response.ok) {
            const data = await response.json();
            displayMoodChart(data);
        }
    } catch (err) {
        console.error('Error loading mood stats:', err);
    }
}

function displayMoodChart(data) {
    const container = document.getElementById('moodChartContainer');
    if (!data.emotion_counts || Object.keys(data.emotion_counts).length === 0) {
        container.innerHTML = '<p style="text-align: center; color: #999;">No emotion data yet</p>';
        return;
    }
    let html = '<div style="display: flex; flex-direction: column; gap: 12px;">';
    Object.entries(data.emotion_counts).forEach(([emotion, count]) => {
        const colors = {
            happy: '#FFD93D',
            sad: '#6C8EBF',
            angry: '#FF6B6B',
            anxious: '#FFA500',
            calm: '#90EE90',
            neutral: '#9DB4C4'
        };
        const color = colors[emotion] || '#808080';
        const width = (count / Math.max(...Object.values(data.emotion_counts))) * 100;
        html += `
            <div style="display: flex; align-items: center; gap: 8px;">
                <span style="width: 80px; font-size: 12px;">${emotion}</span>
                <div style="flex: 1; height: 20px; background: #e0e0e0; border-radius: 4px; overflow: hidden;">
                    <div style="width: ${width}%; height: 100%; background: ${color};"></div>
                </div>
                <span style="width: 30px; font-size: 12px; text-align: right;">${count}</span>
            </div>
        `;
    });
    html += '</div>';
    container.innerHTML = html;
}

async function loadAnalytics() {
    try {
        const response = await fetch(`${API_URL}/dashboard/summary/${currentUser.id}`, {
            headers: { 'Authorization': `Bearer ${authToken}` }
        });
        if (response.ok) {
            const data = await response.json();
            document.getElementById('todayMessages').textContent = data.today.messages;
            document.getElementById('todayEmotions').textContent = data.today.emotions_logged;
            document.getElementById('weekConversations').textContent = data.last_7_days.conversations;
            document.getElementById('totalConversations').textContent = data.all_time.total_conversations;
            const breakdown = document.getElementById('emotionBreakdown');
            let html = '<div style="display: flex; flex-direction: column; gap: 12px;">';
            Object.entries(data.last_7_days.emotion_breakdown).forEach(([emotion, count]) => {
                html += `
                    <div style="display: flex; justify-content: space-between; padding: 8px; background: #f8f9fb; border-radius: 4px;">
                        <span>${emotion}</span>
                        <strong>${count}</strong>
                    </div>
                `;
            });
            html += '</div>';
            breakdown.innerHTML = html;
        }
    } catch (err) {
        console.error('Error loading analytics:', err);
    }
}

async function loadHistory() {
    try {
        const response = await fetch(`${API_URL}/conversations`, {
            headers: { 'Authorization': `Bearer ${authToken}` }
        });
        if (response.ok) {
            const data = await response.json();
            displayConversations(data.conversations);
        }
    } catch (err) {
        console.error('Error loading history:', err);
    }
}

function displayConversations(conversations) {
    const list = document.getElementById('conversationsList');
    if (conversations.length === 0) {
        list.innerHTML = '<p style="color: #999; text-align: center;">No conversations yet</p>';
        return;
    }
    list.innerHTML = conversations.map(conv => `
        <div class="conversation-item" onclick="loadConversationMessages(${conv.id})">
            <div style="margin-bottom: 8px;">
                <strong>${conv.title}</strong>
                <span style="background: #fef3c7; color: #92400e; padding: 2px 6px; border-radius: 4px; font-size: 12px;">
                    ${conv.mood_at_start}
                </span>
            </div>
            <div style="font-size: 12px; color: #999;">
                ${new Date(conv.started_at).toLocaleDateString()} â€¢ ${conv.message_count} messages
            </div>
        </div>
    `).join('');
}

async function loadConversationMessages(conversationId) {
    try {
        const response = await fetch(`${API_URL}/chat_history/${conversationId}`, {
            headers: { 'Authorization': `Bearer ${authToken}` }
        });
        if (response.ok) {
            const data = await response.json();
            displayMessages(data.messages);
        }
    } catch (err) {
        console.error('Error loading messages:', err);
    }
}

function displayMessages(messages) {
    const display = document.getElementById('messagesDisplay');
    if (messages.length === 0) {
        display.innerHTML = '<p style="color: #999; text-align: center;">No messages in this conversation</p>';
        return;
    }
    display.innerHTML = messages.map(msg => {
        const time = new Date(msg.timestamp).toLocaleTimeString([], { 
            hour: '2-digit', 
            minute: '2-digit' 
        });
        const isUser = msg.type === 'user';
        return `
            <div style="margin-bottom: 12px; text-align: ${isUser ? 'right' : 'left'};">
                <div style="
                    display: inline-block;
                    max-width: 70%;
                    padding: 12px 16px;
                    border-radius: 12px;
                    background: ${isUser ? '#6366f1' : '#e5e7eb'};
                    color: ${isUser ? 'white' : '#1f2937'};
                ">
                    <p style="margin: 0;">${escapeHtml(msg.content)}</p>
                    <span style="font-size: 11px; opacity: 0.7; display: block; margin-top: 4px;">
                        ${time}
                        ${msg.emotion ? ` â€¢ ${msg.emotion}` : ''}
                    </span>
                </div>
            </div>
        `;
    }).join('');
    display.scrollTop = display.scrollHeight;
}

function showLoading(show) {
    document.getElementById('loadingSpinner').style.display = show ? 'flex' : 'none';
}
    </script>
</body>
</html>